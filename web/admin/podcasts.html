<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Podcasts - Clean Cast Admin</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body class="bg-slate-900 text-gray-100">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="sidebar flex-shrink-0 hidden md:block">
      <div class="p-6">
        <h1 class="text-2xl font-bold text-white flex items-center gap-2">
          <i class="fas fa-podcast text-blue-500"></i>
          Clean Cast
        </h1>
        <p class="text-sm text-gray-400 mt-1">Admin Panel</p>
      </div>

      <nav class="mt-6">
        <a href="/admin" class="sidebar-item">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
        <a href="/admin/podcasts" class="sidebar-item active">
          <i class="fas fa-podcast"></i>
          <span>Podcasts</span>
        </a>
        <a href="/admin/episodes" class="sidebar-item">
          <i class="fas fa-list"></i>
          <span>Episodes</span>
        </a>
        <a href="/admin/analytics" class="sidebar-item">
          <i class="fas fa-chart-line"></i>
          <span>Analytics</span>
        </a>
        <a href="/admin/settings" class="sidebar-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
      <!-- Header -->
      <header class="bg-slate-800 border-b border-slate-700 px-6 py-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h2 class="text-2xl font-bold text-white">Podcast Management</h2>
            <p class="text-sm text-gray-400 mt-1">Manage your podcast subscriptions</p>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="showAddPodcastModal()" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Add Podcast
            </button>
            <button onclick="showBulkAddModal()" class="btn btn-secondary">
              <i class="fas fa-layer-group"></i>
              Bulk Add
            </button>
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="p-6">
        <!-- Search and Filters -->
        <div class="card mb-6">
          <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1 search-container">
              <i class="fas fa-search search-icon"></i>
              <input
                type="text"
                id="searchInput"
                class="form-input search-input"
                placeholder="Search podcasts by name, description, or artist..."
                onkeyup="debounce(handleSearch, 300)()"
              >
            </div>
            <div class="flex gap-3">
              <button onclick="loadPodcasts()" class="btn btn-secondary">
                <i class="fas fa-sync-alt"></i>
                Refresh
              </button>
              <button onclick="refreshSelected()" class="btn btn-secondary" id="refreshSelectedBtn" disabled>
                <i class="fas fa-sync-alt"></i>
                Refresh Selected
              </button>
            </div>
          </div>
        </div>

        <!-- Bulk Selection Actions -->
        <div id="bulkActions" class="card mb-6 hidden">
          <div class="flex items-center justify-between">
            <p class="text-gray-300">
              <span id="selectedCount">0</span> podcasts selected
            </p>
            <div class="flex gap-3">
              <button onclick="refreshSelected()" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i>
                Refresh Selected
              </button>
              <button onclick="clearSelection()" class="btn btn-secondary">
                Clear Selection
              </button>
            </div>
          </div>
        </div>

        <!-- Podcasts Table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="w-12">
                  <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                </th>
                <th>Podcast</th>
                <th>Type</th>
                <th>Episodes</th>
                <th>Last Updated</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="podcastsTableBody">
              <!-- Table rows will be loaded here -->
              <tr>
                <td colspan="6" class="text-center py-12">
                  <div class="flex justify-center">
                    <div class="spinner"></div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="mt-6"></div>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="/static/js/utils.js"></script>
  <script src="/static/js/api.js"></script>
  <script>
    let currentPage = 1;
    let totalPages = 1;
    let searchQuery = '';
    const itemsPerPage = 20;
    let selectedPodcasts = new Set();

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadPodcasts();
    });

    // Load podcasts
    async function loadPodcasts(page = 1) {
      currentPage = page;
      const tbody = document.getElementById('podcastsTableBody');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12"><div class="flex justify-center"><div class="spinner"></div></div></td></tr>';

      try {
        const offset = (page - 1) * itemsPerPage;
        const result = searchQuery
          ? await api.searchPodcasts(searchQuery, itemsPerPage, offset)
          : await api.getPodcasts(itemsPerPage, offset);

        const podcasts = result.podcasts || [];
        const total = result.total || 0;
        totalPages = Math.ceil(total / itemsPerPage);

        if (podcasts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No podcasts found</td></tr>';
          document.getElementById('pagination').innerHTML = '';
          return;
        }

        let html = '';
        for (const podcast of podcasts) {
          const isSelected = selectedPodcasts.has(podcast.id);
          html += `
            <tr class="${isSelected ? 'bg-slate-700' : ''}">
              <td>
                <input type="checkbox"
                       ${isSelected ? 'checked' : ''}
                       onchange="togglePodcastSelection('${podcast.id}', this.checked)">
              </td>
              <td>
                <div class="flex items-center gap-3">
                  <img src="${podcast.image_url || '/static/images/podcast-placeholder.png'}"
                       alt="${sanitizeHTML(podcast.podcast_name)}"
                       class="w-12 h-12 rounded-lg object-cover"
                       onerror="this.src='/static/images/podcast-placeholder.png'">
                  <div class="min-w-0">
                    <p class="font-medium text-white truncate">${sanitizeHTML(podcast.podcast_name)}</p>
                    <p class="text-sm text-gray-400 truncate">${sanitizeHTML(podcast.artist_name || 'Unknown')}</p>
                  </div>
                </div>
              </td>
              <td>${getPodcastTypeBadge(podcast.type || 'CHANNEL')}</td>
              <td>${formatNumber(podcast.episode_count || 0)}</td>
              <td>${formatDate(podcast.updated_at || podcast.created_at)}</td>
              <td class="text-right">
                <div class="flex justify-end gap-2">
                  <button onclick="viewEpisodes('${podcast.id}')"
                          class="text-blue-400 hover:text-blue-300"
                          title="View Episodes">
                    <i class="fas fa-list"></i>
                  </button>
                  <button onclick="refreshPodcast('${podcast.id}')"
                          class="text-green-400 hover:text-green-300"
                          title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                  <button onclick="copyRSSUrl('${podcast.id}', '${podcast.type}')"
                          class="text-purple-400 hover:text-purple-300"
                          title="Copy RSS URL">
                    <i class="fas fa-rss"></i>
                  </button>
                  <button onclick="viewPodcastDetails('${podcast.id}')"
                          class="text-gray-400 hover:text-gray-300"
                          title="Details">
                    <i class="fas fa-info-circle"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }

        tbody.innerHTML = html;
        updatePagination();
        updateBulkActions();
      } catch (error) {
        console.error('Failed to load podcasts:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-400">Failed to load podcasts</td></tr>';
        showToast('Failed to load podcasts: ' + parseError(error), 'error');
      }
    }

    // Handle search
    function handleSearch() {
      searchQuery = document.getElementById('searchInput').value.trim();
      loadPodcasts(1);
    }

    // Update pagination
    function updatePagination() {
      const paginationHtml = createPagination(currentPage, totalPages, 'loadPodcasts');
      document.getElementById('pagination').innerHTML = paginationHtml;
    }

    // Toggle podcast selection
    function togglePodcastSelection(podcastId, checked) {
      if (checked) {
        selectedPodcasts.add(podcastId);
      } else {
        selectedPodcasts.delete(podcastId);
      }
      updateBulkActions();
      loadPodcasts(currentPage); // Reload to update row styling
    }

    // Toggle select all
    function toggleSelectAll(checkbox) {
      const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const podcastId = cb.onchange.toString().match(/'([^']+)'/)[1];
        if (checkbox.checked) {
          selectedPodcasts.add(podcastId);
          cb.checked = true;
        } else {
          selectedPodcasts.delete(podcastId);
          cb.checked = false;
        }
      });
      updateBulkActions();
      loadPodcasts(currentPage);
    }

    // Update bulk actions visibility
    function updateBulkActions() {
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      const refreshBtn = document.getElementById('refreshSelectedBtn');

      if (selectedPodcasts.size > 0) {
        bulkActions.classList.remove('hidden');
        selectedCount.textContent = selectedPodcasts.size;
        refreshBtn.disabled = false;
      } else {
        bulkActions.classList.add('hidden');
        refreshBtn.disabled = true;
      }
    }

    // Clear selection
    function clearSelection() {
      selectedPodcasts.clear();
      document.getElementById('selectAll').checked = false;
      updateBulkActions();
      loadPodcasts(currentPage);
    }

    // Refresh selected podcasts
    async function refreshSelected() {
      if (selectedPodcasts.size === 0) {
        showToast('No podcasts selected', 'warning');
        return;
      }

      confirmDialog(
        `Refresh ${selectedPodcasts.size} selected podcast(s)?`,
        async () => {
          try {
            const podcastIds = Array.from(selectedPodcasts);
            const result = await api.batchRefreshPodcasts(podcastIds);
            showToast(`Refresh job started. Job ID: ${result.job_id}`, 'success');
            clearSelection();
          } catch (error) {
            showToast('Failed to refresh podcasts: ' + parseError(error), 'error');
          }
        }
      );
    }

    // Refresh single podcast
    async function refreshPodcast(podcastId) {
      try {
        const result = await api.batchRefreshPodcasts([podcastId]);
        showToast(`Refresh job started. Job ID: ${result.job_id}`, 'success');
        setTimeout(() => loadPodcasts(currentPage), 2000);
      } catch (error) {
        showToast('Failed to refresh podcast: ' + parseError(error), 'error');
      }
    }

    // View episodes
    function viewEpisodes(podcastId) {
      window.location.href = `/admin/episodes?podcast_id=${podcastId}`;
    }

    // Copy RSS URL
    function copyRSSUrl(podcastId, type) {
      const baseUrl = window.location.origin;
      const endpoint = type === 'PLAYLIST' ? 'rss' : 'channel';
      const url = `${baseUrl}/${endpoint}/${podcastId}`;
      copyToClipboard(url);
    }

    // View podcast details
    async function viewPodcastDetails(podcastId) {
      showToast('Loading podcast details...', 'info', 1000);
      // This would show a modal with full podcast details
      showToast('Podcast details feature coming soon!', 'info');
    }

    // Show add podcast modal
    function showAddPodcastModal() {
      const modal = showModal('Add Podcast', `
        <div class="form-group">
          <label class="form-label">YouTube Channel/Playlist URL or ID</label>
          <input type="text" id="podcastUrl" class="form-input"
                 placeholder="https://youtube.com/channel/... or channel ID">
          <p class="text-sm text-gray-400 mt-2">
            You can paste a YouTube channel URL, playlist URL, or just the ID
          </p>
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <select id="podcastType" class="form-select">
            <option value="channel">Channel</option>
            <option value="playlist">Playlist</option>
          </select>
        </div>
      `, [
        {
          id: 'addPodcastBtn',
          text: 'Add Podcast',
          type: 'primary'
        },
        {
          id: 'cancelBtn',
          text: 'Cancel',
          type: 'secondary'
        }
      ]);

      document.getElementById('addPodcastBtn').addEventListener('click', async () => {
        const urlInput = document.getElementById('podcastUrl').value.trim();
        const type = document.getElementById('podcastType').value;

        if (!urlInput) {
          showToast('Please enter a URL or ID', 'warning');
          return;
        }

        const podcastId = validateYoutubeId(urlInput);
        if (!podcastId) {
          showToast('Invalid YouTube URL or ID', 'error');
          return;
        }

        try {
          closeModal();
          showToast('Adding podcast...', 'info');
          const result = await api.batchAddPodcasts([{ id: podcastId, type }]);
          showToast(`Podcast add job started. Job ID: ${result.job_id}`, 'success');
          setTimeout(() => loadPodcasts(currentPage), 2000);
        } catch (error) {
          showToast('Failed to add podcast: ' + parseError(error), 'error');
        }
      });

      document.getElementById('cancelBtn').addEventListener('click', closeModal);
    }

    // Show bulk add modal
    function showBulkAddModal() {
      const modal = showModal('Bulk Add Podcasts', `
        <div class="form-group">
          <label class="form-label">Podcast List</label>
          <textarea id="bulkPodcastList" class="form-textarea"
                    placeholder="Enter one podcast URL or ID per line...&#10;https://youtube.com/channel/...&#10;PLxxxxxxxxxxxxxxx&#10;UCxxxxxxxxxxxxxxx"
                    rows="10"></textarea>
          <p class="text-sm text-gray-400 mt-2">
            Enter one podcast URL or ID per line. The type will be auto-detected.
          </p>
        </div>
      `, [
        {
          id: 'bulkAddBtn',
          text: 'Add All',
          type: 'primary'
        },
        {
          id: 'cancelBulkBtn',
          text: 'Cancel',
          type: 'secondary'
        }
      ]);

      document.getElementById('bulkAddBtn').addEventListener('click', async () => {
        const input = document.getElementById('bulkPodcastList').value.trim();
        if (!input) {
          showToast('Please enter at least one podcast', 'warning');
          return;
        }

        const lines = input.split('\n').map(l => l.trim()).filter(l => l);
        const podcasts = [];

        for (const line of lines) {
          const id = validateYoutubeId(line);
          if (id) {
            // Auto-detect type based on ID pattern
            const type = id.startsWith('PL') ? 'playlist' : 'channel';
            podcasts.push({ id, type });
          }
        }

        if (podcasts.length === 0) {
          showToast('No valid podcasts found', 'error');
          return;
        }

        try {
          closeModal();
          showToast(`Adding ${podcasts.length} podcasts...`, 'info');
          const result = await api.batchAddPodcasts(podcasts);
          showToast(`Bulk add job started. Job ID: ${result.job_id}`, 'success');
          setTimeout(() => loadPodcasts(currentPage), 2000);
        } catch (error) {
          showToast('Failed to add podcasts: ' + parseError(error), 'error');
        }
      });

      document.getElementById('cancelBulkBtn').addEventListener('click', closeModal);
    }
  </script>
</body>
</html>
